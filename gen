#!/bin/bash
# Fully automatic Pi config generator with multiple config types
# Usage: ./gen [server|desktop] [hostname]

set -e

# Function to start HTTP server
start_server() {
    local PORT=${1:-8000}
    local CONFIG_URL=$2
    
    echo ""
    echo "ðŸŒ Starting HTTP server on port $PORT..."
    echo ""
    echo "ðŸ“‹ Your config URL (copied to clipboard):"
    echo "   $CONFIG_URL"
    echo ""
    echo "ðŸ“¥ In Pi Imager:"
    echo "   1. Choose OS (Lite for server, Full for desktop)"
    echo "   2. Choose Storage"
    echo "   3. Press Cmd/Ctrl+Shift+X"
    echo "   4. Select 'Use custom URL'"
    echo "   5. Paste (Cmd+V) - URL already in clipboard!"
    echo ""
    echo "â¹ï¸  Press Ctrl+C to stop server"
    echo ""
    cd /tmp && python3 -m http.server $PORT
}

# Config selection
CONFIG_TYPE=${1:-server}
HOSTNAME=${2:-pi5main}

# Validate config type
if [[ ! "$CONFIG_TYPE" =~ ^(server|desktop)$ ]]; then
    echo "âŒ Invalid config type. Use 'server' or 'desktop'"
    echo "Usage: ./gen [server|desktop] [hostname]"
    exit 1
fi

CONFIG_FILE="config-${CONFIG_TYPE}.json"
OUTPUT="/tmp/pi-config-${CONFIG_TYPE}.json"

if [ ! -f "$CONFIG_FILE" ]; then
    echo "âŒ Config file not found: $CONFIG_FILE"
    exit 1
fi

echo "ðŸ”§ Generating $CONFIG_TYPE config for $HOSTNAME..."
echo ""

# Auto-detect WiFi SSID (macOS)
SSID=""
if command -v networksetup >/dev/null 2>&1; then
    # Try to get currently connected WiFi
    WIFI_DEVICE=$(networksetup -listallhardwareports | awk '/Wi-Fi/{getline; print $2}')
    if [ -n "$WIFI_DEVICE" ]; then
        SSID=$(networksetup -getairportnetwork "$WIFI_DEVICE" 2>/dev/null | sed 's/Current Wi-Fi Network: //')
        if [[ "$SSID" == *"not associated"* ]] || [ -z "$SSID" ]; then
            SSID=""
        fi
    fi
    
    # If not connected, get the preferred network from system preferences
    if [ -z "$SSID" ] && [ -n "$WIFI_DEVICE" ]; then
        SSID=$(networksetup -listpreferredwirelessnetworks "$WIFI_DEVICE" 2>/dev/null | head -2 | tail -1 | xargs)
        if [ -n "$SSID" ]; then
            echo "ðŸ“¡ Using preferred WiFi network: $SSID"
        fi
    fi
fi

# Fallback to Linux methods
if [ -z "$SSID" ]; then
    if command -v nmcli >/dev/null 2>&1; then
        SSID=$(nmcli -t -f active,ssid dev wifi | grep '^yes' | cut -d: -f2)
    elif command -v iwgetid >/dev/null 2>&1; then
        SSID=$(iwgetid -r)
    fi
fi

if [ -z "$SSID" ]; then
    echo "âš ï¸  Could not auto-detect WiFi SSID"
    read -p "Enter WiFi SSID: " SSID
else
    if [[ ! "$SSID" == *"preferred"* ]]; then
        echo "ðŸ“¡ Detected WiFi: $SSID"
    fi
fi

# Get WiFi password from keychain (macOS only)
WIFI_PASS=""
if command -v security >/dev/null 2>&1 && [ -n "$SSID" ]; then
    CURRENT_USER=$(whoami)
    WIFI_PASS=$(security find-generic-password -ga "$SSID" 2>&1 >/dev/null | grep "password:" | cut -d'"' -f2)
    if [ -n "$WIFI_PASS" ]; then
        echo "ðŸ”‘ WiFi password retrieved from keychain (user: $CURRENT_USER)"
    fi
fi

if [ -z "$WIFI_PASS" ]; then
    echo "âš ï¸  Could not get WiFi password from keychain"
    read -sp "Enter WiFi password: " WIFI_PASS
    echo
fi

# Get Pi user password (use env var, secrets.env, or prompt)
if [ -z "$PI_PASSWORD" ]; then
    if [ -f "secrets.env" ]; then
        source secrets.env 2>/dev/null
        echo "ðŸ” Pi password loaded from secrets.env"
    fi
fi

if [ -z "$PI_PASSWORD" ]; then
    echo ""
    read -sp "Enter Pi user password for 'rege': " PI_PASSWORD
    echo
fi

# Auto-find SSH key (find any .pub file in ~/.ssh/)
SSH_KEY=""
if [ -f "$HOME/.ssh/id_ed25519.pub" ]; then
    SSH_KEY=$(cat "$HOME/.ssh/id_ed25519.pub")
    echo "ðŸ” Using SSH key: ~/.ssh/id_ed25519.pub"
elif [ -f "$HOME/.ssh/id_rsa.pub" ]; then
    SSH_KEY=$(cat "$HOME/.ssh/id_rsa.pub")
    echo "ðŸ” Using SSH key: ~/.ssh/id_rsa.pub"
else
    # Find any .pub file in ~/.ssh/
    FIRST_KEY=$(find "$HOME/.ssh" -name "*.pub" -type f 2>/dev/null | head -1)
    if [ -n "$FIRST_KEY" ]; then
        SSH_KEY=$(cat "$FIRST_KEY")
        echo "ðŸ” Using SSH key: $FIRST_KEY"
    else
        echo "âš ï¸  No SSH key found in ~/.ssh/"
        echo "ðŸ’¡ Generate one with: ssh-keygen -t ed25519"
        SSH_KEY="YOUR_SSH_KEY_HERE"
    fi
fi

echo ""
echo "âš™ï¸  Generating config..."

# Generate config
cat "$CONFIG_FILE" | \
    sed "s|pi5main|$HOSTNAME|g" | \
    sed "s|PASSWORD|$PI_PASSWORD|g" | \
    sed "s|WIFI_SSID|$SSID|g" | \
    sed "s|WIFI_PASS|$WIFI_PASS|g" | \
    sed "s|SSH_KEY|$SSH_KEY|g" > "$OUTPUT"

# Copy to clipboard
if command -v pbcopy >/dev/null 2>&1; then
    cat "$OUTPUT" | pbcopy
    echo "âœ… Config copied to clipboard (macOS)"
elif command -v xclip >/dev/null 2>&1; then
    cat "$OUTPUT" | xclip -selection clipboard
    echo "âœ… Config copied to clipboard (Linux)"
elif command -v clip >/dev/null 2>&1; then
    cat "$OUTPUT" | clip
    echo "âœ… Config copied to clipboard (Windows)"
fi

echo "âœ… Config saved to: $OUTPUT"
echo ""
echo "ðŸ“‹ Configuration:"
echo "  Type: $CONFIG_TYPE"
echo "  Hostname: $HOSTNAME"
echo "  User: rege"
echo "  WiFi: $SSID"
echo "  SSH Key: ${SSH_KEY:0:50}..."
echo ""
if [ "$CONFIG_TYPE" = "server" ]; then
    echo "ðŸ–¥ï¸  Server optimizations:"
    echo "  â€¢ Bluetooth disabled"
    echo "  â€¢ Audio disabled"
    echo "  â€¢ GPU memory: 16MB (minimal)"
    echo "  â€¢ Splash screen disabled"
    echo "  â€¢ Boot delay: 0s"
elif [ "$CONFIG_TYPE" = "desktop" ]; then
    echo "ðŸ–¥ï¸  Desktop optimizations:"
    echo "  â€¢ GPU memory: 256MB"
    echo "  â€¢ HDMI hotplug enabled"
    echo "  â€¢ Overscan disabled"
fi
# Copy URL to clipboard
PORT=8000
CONFIG_URL="http://localhost:$PORT/$(basename $OUTPUT)"

if command -v pbcopy >/dev/null 2>&1; then
    echo "$CONFIG_URL" | pbcopy
    echo "ðŸ“‹ URL copied to clipboard!"
elif command -v xclip >/dev/null 2>&1; then
    echo "$CONFIG_URL" | xclip -selection clipboard
    echo "ðŸ“‹ URL copied to clipboard!"
elif command -v clip >/dev/null 2>&1; then
    echo "$CONFIG_URL" | clip
    echo "ðŸ“‹ URL copied to clipboard!"
fi

# Auto-start HTTP server
start_server $PORT "$CONFIG_URL"